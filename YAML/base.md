# Как парсится YAML и примеры

`YAML`: конфигурации, которые удобно читать

Язык, на котором пишется файл конфигурации для `Docker Compose`, — `YAML`. Это язык, родственный `JSON` и `XML`, и в настоящее время его в основном применяют для хранения структурированных данных в текстовых файлах.

Данные в `YAML` хранятся в виде словарей и списков. `Словари и списки` в YAML `не объявляются: их просто пишут с первого элемента`.

- Словарь в YAML записывается так:

```yaml
# Вот словарь из двух элементов:
# ключ: значение.
first_name: Стас
last_name: Басов
```

- Элементы списка обозначаются символом `-`:

```yaml
# Вот список:
- Bread
- Milk
- Eggs
# Список тоже не объявляется.
```

Словари и списки поддерживают вложенность: например, значением словаря может быть список или другой словарь.
Вложенность в YAML обозначается так же, как и в Python: отступами. [Спецификации](https://yaml.org/spec/1.2-old/spec.html#id2777534) YAML рекомендуют использовать в качестве отступов пробелы.

В словарь вложены словарь и список:

```yaml
# Это словарь с ключами person и shopping_list:
person:
  first_name: Стас
  last_name: Басов
shopping_list:
  - Egg
  - Bread
```

## Большой пример синтетический:

```yaml
# У словарей и списков в YAML нет названий.
# В этом файле всё вложено в корневой словарь;
# первый ключ корневого словаря — practicum, второй — other_life

practicum:                 # Первый элемент корневого словаря
  programming:               # Первый элемент словаря, вложенного в корневой
    - testing                  # Значение элемента programming — это список
    - frontend
    - backend:                  # backend — первый элемент вложенного словаря,
      - base_python             # его значение — список
      - deep_python
      - django
      - api
      - infrastructure
      - algorithms
    - devops
    - algorithms
  data_analysis:             # Второй элемент словаря, вложенного в корневой
    - SQL
    - data_analysis
    - data_engineering
    - business_analysis
  design:                    # Третий элемент словаря, вложенного в корневой
    - interface
    - graphic
    - presentation
  management:                # Четвёртый элемент словаря, вложенного в корневой
    - project_manager
    - team_management
    - it-mentor
    - product_manager
  marketing:                 # Пятый элемент словаря, вложенного в корневой
    - brand_management
    - internet_marketing
    - market_analysis
other_life:                # Второй элемент корневого словаря
  - cinema                   # В этот элемент вложен список
  - dream
  - eat
  - party
  - pets
  - sport
```

## Большой пример, приближенный к реальным проектам

```yaml
# Файл docker-compose.yml

# Версия docker-compose
version: '3'

# Перечень volume
volumes:
  pg_data:

# Перечень контейнеров
services:
  # Имя и описание первого контейнера; имя выбирает разработчик. 
  # Это контейнер БД
  db:
    # Из какого образа запустить контейнер:
    image: postgres:13.10
    # Файл (или список файлов) с переменными окружения
    env_file: .env
    # Какой volume подключить для этого контейнера
    volumes:
      - pg_data:/var/lib/postgresql/data
  # Имя и описание контейнера с бэкендом
  backend:
    # Из какого Dockerfile собирать образ для этого контейнера:
    build: ./backend/
    env_file: .env
    # Какие контейнеры нужно запустить до старта этого контейнера:
    depends_on:
      - db
  # Имя третьего контейнера. Это контейнер с фронтендом
  frontend:
    env_file: .env
    build: ./frontend/
```

- Объяснение примера:

Внимание, в новом `compose` на состояние 2024.09.01 + параметр `version` не указывается и приводит к ошибке.

`version` — версия спецификации файла docker-compose.yml. Обязательный параметр. От версии к версии набор доступных команд меняется, и какие-то команды из новых версий могут не поддерживаться старыми версиями Docker Compose. Узнать, какая версия Docker Compose установлена на компьютере, можно с помощью команды `docker compose version`.

`volumes` — перечень `volumes` для докера, необязательный параметр. Для каждого имени volume через двоеточие можно указать его подробные настройки. Их можно и не указывать — докер применит настройки по умолчанию.

`services` — названия и описания контейнеров, которые должны быть запущены. В листинге описаны три контейнера: `db, backend и frontend`.

Ключи в конфигурации можно указывать в любом порядке. В примере сначала указаны `volumes`, а потом `services`: при описании контейнеров удобнее видеть, какие volumes уже созданы.

Описание каждого контейнера — это YAML-словарь, значения в этом словаре похожи на параметры запуска, которые вы применяли при ручном старте контейнеров. Вот она, автоматизация!

- В описании контейнера объявляется:
- - image или build: <address> (одно из двух):
- - - image — из какого образа создать и запустить контейнер;
- - - build: <address> — создать образ из докерфайла, который лежит в директории <address>, и запустить контейнер из этого образа.
- - volumes — список подключаемых к контейнеру volumes:

```yaml
  volumes:
    - имя_volume:директория_контейнера
```

Другой распространённый вариант — просто указать директорию контейнера, для которой будет создан volume:

```yaml
  volumes:
    - директория_контейнера
```

Такой volume называется анонимным volume (у него не будет имени), его не нужно описывать в общем блоке `volumes`. Остальные способы создания `volumes` можно посмотреть в [документации](https://docs.docker.com/reference/compose-file/services/#volumes).

`env_file` указывает один или несколько файлов с переменными окружения для контейнера.

`depends_on` — список контейнеров, которые должны быть запущены перед запуском описываемого контейнера. Значение ключа `depends_on` — список: иногда запускаемый контейнер зависит не от одного, а от нескольких других контейнеров. В листинге сказано, что контейнер `backend` должен быть запущен после контейнера db: при старте Django-приложения база данных должна быть уже доступна.

Дополнительно в `depends_on` можно указать состояние предыдущего контейнера, при котором можно запустить текущий контейнер, — это описано в [документации](https://docs.docker.com/reference/compose-file/services/#depends_on).
